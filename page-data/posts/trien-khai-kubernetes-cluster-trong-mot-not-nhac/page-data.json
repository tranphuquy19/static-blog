{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/trien-khai-kubernetes-cluster-trong-mot-not-nhac","result":{"data":{"markdownRemark":{"id":"987a5e7b-1047-56f7-9d06-af1801fa04b2","html":"<p><img src=\"/media/k8s-vagrant-1.png\" alt=\"Kubernetes\"></p>\n<p>Trong những năm gần đây, nhiều ứng dụng đã được container hóa (containerized) bằng cách sử dụng docker. Việc đó đã giúp tốc độ phát triển ứng dụng nhanh chưa từng thấy, phải nói “người người dùng docker, nhà nhà dùng docker”. Với việc triển khai hệ thống chỉ sử dụng docker, khiến việc quản lý các containers là vô cùng khó khăn. Vì thế, ông anh to lớn Google đã cho ra đời Kubernetes để giải quyết vấn đề trên và trên hết là free.</p>\n<p>Nhưng để tiếp cận nó thì không hẳn là free. Để xây dựng một k8s cluster, thì bạn phải có ít nhất là 3 VPS, hoặc sử dụng các dịch vụ cloud như Google Kubernetes Engine (GKE), Elastic Container Service for Kubernetes（EKS）,.. và tất nhiên là tốn phí. Để có thể setup nhanh 1 k8s cluster ở local bạn có thể sử dụng MiniKube, hoặc MicroK8s,.. Tuy nhiên các giải pháp trên có một vài nhược điểm như khó custom, không phải là k8s chính chủ,.. </p>\n<p><strong>TL;DR</strong> Trong bài viết này, mình sẽ hướng dẫn setup nhanh một k8s cluster trong vài giây mà không cần phải setup lằng nhằng bằng cách sử dụng <a href=\"https://www.vagrantup.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Vagrant</a>. Mình sẽ dành 1 bài để viết về thằng Vagrant sau.</p>\n<blockquote>\n<p>>>> Kubernetes có một người anh em cùng cha khác ông nội là Docker Swarm</p>\n</blockquote>\n<h2 id=\"1-chuẩn-bị\" style=\"position:relative;\"><a href=\"#1-chu%E1%BA%A9n-b%E1%BB%8B\" aria-label=\"1 chuẩn bị permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Chuẩn bị</h2>\n<ul>\n<li>Một PC có ít nhất 8GB ram với Virtual box được cài sẵn</li>\n<li>Cài đặt <a href=\"https://www.vagrantup.com/downloads\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Vagrant</a></li>\n</ul>\n<h2 id=\"2-triển-khai\" style=\"position:relative;\"><a href=\"#2-tri%E1%BB%83n-khai\" aria-label=\"2 triển khai permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Triển khai</h2>\n<h3 id=\"21-hạ-tầng-cluster\" style=\"position:relative;\"><a href=\"#21-h%E1%BA%A1-t%E1%BA%A7ng-cluster\" aria-label=\"21 hạ tầng cluster permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Hạ tầng cluster</h3>\n<p>Như đã nói, chúng ta sẽ dùng Vagrant để xây dựng cluster bao gồm 1 master và 2 worker như sau:</p>\n<table>\n<thead>\n<tr>\n<th>node</th>\n<th>hostname</th>\n<th>cpus</th>\n<th>memory</th>\n<th>IP</th>\n<th>OS</th>\n<th>username/password</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>master</td>\n<td>master.dora</td>\n<td>2</td>\n<td>2GB</td>\n<td>172.16.10.100</td>\n<td>Centos7</td>\n<td>root/11231123</td>\n</tr>\n<tr>\n<td>worker1</td>\n<td>worker1.dora</td>\n<td>1</td>\n<td>1GB</td>\n<td>172.16.10.101</td>\n<td>Centos7</td>\n<td>root/11231123</td>\n</tr>\n<tr>\n<td>worker2</td>\n<td>worker2.dora</td>\n<td>1</td>\n<td>1GB</td>\n<td>172.16.10.102</td>\n<td>Centos7</td>\n<td>root/11231123</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>>>> IP các node có thể setup tùy ý, tuy nhiên theo kinh nghiệm của mình thì nên khác với CIDR của một số  addons mạng như Calico, Flannel,… để tránh xung đột <a href=\"https://kubernetes.io/docs/concepts/cluster-administration/addons/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Xem thêm</a></p>\n</blockquote>\n<h3 id=\"22-vagrant-boxes-structure\" style=\"position:relative;\"><a href=\"#22-vagrant-boxes-structure\" aria-label=\"22 vagrant boxes structure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Vagrant boxes structure</h3>\n<p>Chúng ta sẽ có cấu trúc thư mục và nội dung từng file như sau</p>\n<deckgo-highlight-code language=\"iecst\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">.\n├── master\n│   └── Vagrantfile\n├── woker1\n│   └── Vagrantfile\n└── worker2\n    └── Vagrantfile</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"ruby\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\"># Nội dung ./master/Vagrantfile\n# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure(&quot;2&quot;) do |config|\n    # Vagrant box: https://app.vagrantup.com/tranphuquy19/boxes/centos7-k8s\n    config.vm.box = &quot;tranphuquy19/centos7-k8s&quot;\n    config.vm.box_version = &quot;1.0.0&quot;\n    config.vm.network &quot;private_network&quot;, ip: &quot;172.16.10.100&quot; # IP của node master\n    config.vm.hostname = &quot;master.dora&quot; # Hostname\n  \n    config.vm.provider &quot;virtualbox&quot; do |vb|\n        vb.name = &quot;master.dora&quot; # Tên máy ảo\n        vb.cpus = 2 # Số lượng CPU\n        vb.memory = &quot;2048&quot; # Dung lượng RAM\n    end\n\n    # Setup password và thêm hostname các nodes vào file hosts\n    config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL\necho &quot;11231123&quot; | passwd --stdin root\nsed -i &#39;s/^PasswordAuthentication no/PasswordAuthentication yes/&#39; /etc/ssh/sshd_config\nsystemctl reload sshd\ncat &gt;&gt;/etc/hosts&lt;&lt;EOF\n172.16.10.100 master.dora\n172.16.10.101 worker1.dora\n172.16.10.102 worker2.dora\nEOF\nSHELL\n\nend</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"ruby\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\"># Nội dung ./worker1/Vagrantfile\n# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure(&quot;2&quot;) do |config|\n    config.vm.box = &quot;tranphuquy19/centos7-k8s&quot;\n    config.vm.box_version = &quot;1.0.0&quot;\n    config.vm.network &quot;private_network&quot;, ip: &quot;172.16.10.101&quot;\n    config.vm.hostname = &quot;worker1.dora&quot;\n  \n    config.vm.provider &quot;virtualbox&quot; do |vb|\n        vb.name = &quot;worker1.dora&quot;\n        vb.cpus = 1\n        vb.memory = &quot;1024&quot;\n    end\n  \n    config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL\necho &quot;11231123&quot; | passwd --stdin root\nsed -i &#39;s/^PasswordAuthentication no/PasswordAuthentication yes/&#39; /etc/ssh/sshd_config\nsystemctl reload sshd\ncat &gt;&gt;/etc/hosts&lt;&lt;EOF\n172.16.10.100 master.dora\n172.16.10.101 worker1.dora\n172.16.10.102 worker2.dora\nEOF\nSHELL\n\nend</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"ruby\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\"># Nội dung ./worker2/Vagrantfile\n# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure(&quot;2&quot;) do |config|\n    config.vm.box = &quot;tranphuquy19/centos7-k8s&quot;\n    config.vm.box_version = &quot;1.0.0&quot;\n    config.vm.network &quot;private_network&quot;, ip: &quot;172.16.10.102&quot;\n    config.vm.hostname = &quot;worker2.dora&quot;\n  \n    config.vm.provider &quot;virtualbox&quot; do |vb|\n        vb.name = &quot;worker2.dora&quot;\n        vb.cpus = 1\n        vb.memory = &quot;1024&quot;\n    end\n  \n    config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL\necho &quot;11231123&quot; | passwd --stdin root\nsed -i &#39;s/^PasswordAuthentication no/PasswordAuthentication yes/&#39; /etc/ssh/sshd_config\nsystemctl reload sshd\ncat &gt;&gt;/etc/hosts&lt;&lt;EOF\n172.16.10.100 master.dora\n172.16.10.101 worker1.dora\n172.16.10.102 worker2.dora\nEOF\nSHELL\n\nend</code>\n        </deckgo-highlight-code>\n<p>Box <code class=\"language-text\">tranphuquy19/centos7-k8s</code> là box mình build dựa trên HĐH <a href=\"https://app.vagrantup.com/tranphuquy19/boxes/centos7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Centos7</a>, kèm theo đó là Docker v1.13.1 và Kubernetes v1.20.4</p>\n<p><code class=\"language-text\">cd</code> từng thư mục và chạy <code class=\"language-text\">vagrant up</code>, Vagrant sẽ giúp chúng ta cấu hình mạng, cpu, dung lượng ram, cũng như hệ điều hành một cách tự động theo files chúng ta đã mô tả</p>\n<p><img src=\"/media/k8s-vagrant-2.png\" alt=\"vagrant up\"></p>\n<p>Đến đây, vagrant đã giúp chúng ta khởi tạo một mạng với IP <code class=\"language-text\">172.16.10.0/24</code>. Các nodes master, worker1, worker2 được gắn với các IP lần lượt là <code class=\"language-text\">172.16.10.100</code>, <code class=\"language-text\">172.16.10.101</code>, <code class=\"language-text\">172.16.10.102</code></p>\n<blockquote>\n<p>>>> Thực hiện lệnh ping đến hostname của node khác để kiểm tra kết nối mạng giữa các node với nhau. Vd: <code class=\"language-text\">ping worker1.dora</code>, <code class=\"language-text\">ping master.dora</code>, …</p>\n</blockquote>\n<p>Quá trình cài nhanh hoặc chậm tùy thuộc vào tốc độ mạng của bạn. Sau khi cài đặt xong chúng ta <code class=\"language-text\">ssh</code> đến từng node bằng lệnh <code class=\"language-text\">ssh root@172.16.10.x</code> với password là <code class=\"language-text\">11231123</code></p>\n<p><img src=\"/media/k8s-vagrant-3.png\" alt=\"vagrant up\"></p>\n<h3 id=\"23-setup-k8s-cluster\" style=\"position:relative;\"><a href=\"#23-setup-k8s-cluster\" aria-label=\"23 setup k8s cluster permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 Setup k8s cluster</h3>\n<p>Với box <a href=\"https://app.vagrantup.com/tranphuquy19/boxes/centos7-k8s\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">tranphuquy19/centos7-k8s</a> đã được cài đặt sẵn docker và k8s. Chúng ta tiến hành Init k8s và join các node vào kube cluster mà không cần phải trải qua các bước cài đặt rườm rà. Chạy lần lượt các lệnh sau:</p>\n<deckgo-highlight-code language=\"bash\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\"># Tại node master\n# Khởi tạo kube master, với pod-network-cidr của Calico\nkubeadm init --apiserver-advertise-address 172.16.10.100 --pod-network-cidr=192.168.0.0/16</code>\n        </deckgo-highlight-code>\n<p>Đến đây, khi chạy lệnh <code class=\"language-text\">kubectl</code> chúng ta sẽ gặp lỗi <code class=\"language-text\">The connection to the server localhost:8080 was refused - did you specify the right host or port?</code> Vì chúng ta chưa chưa cấu hình môi trường cho nó. Để fix lỗi này chúng ta chạy lệnh <code class=\"language-text\">export KUBECONFIG=/etc/kubernetes/admin.conf</code> - và để tránh phải run lệnh trên mỗi khi đăng nhập, chúng ta chạy lệnh sau: </p>\n<deckgo-highlight-code language=\"bash\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">echo &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot; &gt;&gt;  ~/.bashrc</code>\n        </deckgo-highlight-code>\n<p>Với việc thêm <code class=\"language-text\">export KUBECONFIG=/etc/kubernetes/admin.conf</code> vào file <code class=\"language-text\">.bashrc</code> nó sẽ được chạy mỗi khi ta đăng nhập vào node. Tiếp theo, ta chạy lệnh <code class=\"language-text\">exit</code> để đăng xuất vào đăng nhập lại với ssh đã nói ở trên</p>\n<p>Chúng ta tiến hành cài đặt network policy provider cho k8s cluster</p>\n<deckgo-highlight-code language=\"bash\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\"># Tại node master\nkubectl apply -f https://docs.projectcalico.org/v3.10/manifests/calico.yaml</code>\n        </deckgo-highlight-code>\n<p>Đến đây, việc setup trên node master cơ bản đã hoàn thiện. Chạy lệnh sau để lấy join command</p>\n<deckgo-highlight-code language=\"bash\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\"># Tại node master\nkubeadm token create --print-join-command</code>\n        </deckgo-highlight-code>\n<p>Lệnh trên sẽ output ra chuỗi như sau, chúng ta copy chuỗi đó và paste vào worker1 và worker2 để join 2 node này vào cluster</p>\n<deckgo-highlight-code language=\"bash\"  line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">kubeadm join 172.16.10.100:6443 --token jdkri5.0efclctyqi5wzbw9 --discovery-token-ca-cert-hash sha256:8ea0c3f1ade7ebb0220a86ddecf547129c74922db9c874353dee9e8348cf2eb0</code>\n        </deckgo-highlight-code>\n<p><img src=\"/media/k8s-vagrant-4.png\" alt=\"join command\"></p>\n<p>Chạy lệnh <code class=\"language-text\">kubectl get nodes</code> trên master node để kiểm tra các nodes hiện có trong cluster. Nếu như hình bên dưới là đã thành công</p>\n<p><img src=\"/media/k8s-vagrant-5.png\" alt=\"kubectl get nodes\"></p>\n<blockquote>\n<p>Có thể mất 1-2 phút để kube tiến hành cài đặt và join node vào cluster (STATUS = Ready)</p>\n</blockquote>\n<p>Đến đây bạn đã có 1 Kubernetes cluster để vọc vạch và tìm hiểu. Chúc các bạn thành công! 😙</p>","fields":{"slug":"/posts/trien-khai-kubernetes-cluster-trong-mot-not-nhac","tagSlugs":["/tag/devops/","/tag/kubernetes/","/tag/vagrant/"]},"frontmatter":{"date":"2021-03-13T11:20:27.612Z","description":"DevOps: Triển khai Kubernetes cluster trong một nốt nhạc","tags":["devops","kubernetes","vagrant"],"title":"DevOps - Triển khai Kubernetes cluster trong một nốt nhạc","socialImage":"/media/k8s-vagrant-1.png"}}},"pageContext":{"slug":"/posts/trien-khai-kubernetes-cluster-trong-mot-not-nhac"}},"staticQueryHashes":["251939775","3032201271","401334301"]}